name: github-actions
on: [push]
jobs:
  actions-windows-gpu:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v3
      - name: cmake
        run: |
          C:\Users\Administrator\AppData\Local\JetBrains\Toolbox\apps\CLion\ch-0\221.5921.27\bin\cmake\win\bin\cmake.exe -DCMAKE_BUILD_TYPE=Release -DCMAKE_MAKE_PROGRAM=C:/Users/Administrator/AppData/Local/JetBrains/Toolbox/apps/CLion/ch-0/221.5921.27/bin/ninja/win/ninja.exe -G Ninja -S E:\actions-runner-demo\_work\AisDeployC-Demo\AisDeployC-Demo -B E:\actions-runner-demo\_work\AisDeployC-Demo\AisDeployC-Demo\cmake-build-release
      - name: build
        run: |
          cd E:\actions-runner-demo\_work\AisDeployC-Demo\AisDeployC-Demo\cmake-build-release
          C:\Users\Administrator\AppData\Local\JetBrains\Toolbox\apps\CLion\ch-0\221.5921.27\bin\cmake\win\bin\cmake.exe --build .
      - name: Run Test
        run: |
          cd E:\actions-runner-demo\_work\AisDeployC-Demo\AisDeployC-Demo\cmake-build-release
          COPY E:\actions-runner\_work\AisDeployC\AisDeployC\cmake-build-release\AisDeployC*.dll .\
          COPY E:\onnxruntime-win-gpu-x64-1.8.1\lib\onnxruntime*.dll .\
          .\basic.exe
      - name: Run PyTest
        run: |
          cd E:\actions-runner-demo\_work\AisDeployC-Demo\AisDeployC-Demo
          py.test tests/test_interface.py -s
  actions-linux-gpu:
    runs-on: self-hosted-linux
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '14'
      - name: configure
        run: mkdir build && cd build && cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-Werror" ..
      - name: make
        run: cd build && make -j8
      - name: copy libs
        run: cd /home/N3_3090U5/projects/actions-runner-demo/_work/AisDeployC-Demo/AisDeployC-Demo/build/ && cp -f /home/N3_3090U5/projects/actions-runner/_work/AisDeployC/AisDeployC/build/*.so* ./
      - name: Run Test
        run: cd /home/N3_3090U5/projects/actions-runner-demo/_work/AisDeployC-Demo/AisDeployC-Demo/build/ && CUDA_VISIBLE_DEVICES=3 ./basic
      - name: Run PyTest
        run: cd /home/N3_3090U5/projects/actions-runner-demo/_work/AisDeployC-Demo/AisDeployC-Demo/&& cp -f ./build/*.so* ./ && CUDA_VISIBLE_DEVICES=3 python -m pytest -s tests/test_interface.py
